---
phase: 04-tender-integration
plan: 03
type: execute
wave: 1
depends_on: [04-02]
files_modified: [src/pages/Projects/tabs/TendersTab.tsx, src/services/tendersService.ts]
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Add Tender modal includes required estimate dropdown"
    - "Cannot submit Add Tender form without selecting estimate"
    - "All new tenders are linked to an estimate (no standalone tenders)"
    - "createTender service validates estimate_id is present"
  artifacts:
    - path: "src/pages/Projects/tabs/TendersTab.tsx"
      provides: "Add Tender modal with estimate selector and validation"
      contains: "estimate_id.*required"
    - path: "src/services/tendersService.ts"
      provides: "createTender validation requiring estimate_id"
      contains: "if.*!tender.estimate_id.*throw"
  key_links:
    - from: "Add Tender modal estimate dropdown"
      to: "estimatesService.getEstimates"
      via: "fetch on modal open"
      pattern: "getEstimates.*projectId"
    - from: "Add Tender form submission"
      to: "createTender with estimate_id"
      via: "tenderForm.estimate_id"
      pattern: "estimate_id:.*tenderForm\\.estimate_id"
---

<objective>
Enforce estimate requirement - prevent standalone tenders by adding estimate selector to Add Tender modal

**Purpose:** Resolve gap where users can create tenders without estimates, breaking documentation requirement. User reported: "we need to remove adding tender without estimation [this is a must to know that all is documented]"

**Output:** All tenders must be linked to an estimate. Add Tender modal has required estimate dropdown with validation at UI and service layers.
</objective>

<execution_context>
@C:\Users\ester\ABcon\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ester\ABcon\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\ester\ABcon\.planning\STATE.md
@C:\Users\ester\ABcon\.planning\estimate-integration\ROADMAP.md
@C:\Users\ester\ABcon\.planning\estimate-integration\phases\04-tender-integration\04-01-SUMMARY.md
@C:\Users\ester\ABcon\.planning\estimate-integration\phases\04-tender-integration\04-02-PLAN.md

## Gap Details

**Root cause:** Add Tender modal (TendersTab.tsx lines 914-1028) has no estimate selector. Infrastructure exists (migration, types, service) but UI disconnected. No validation enforcing estimate requirement.

**Failed truth:** "All tenders must be linked to an estimate - cannot create standalone tender"

**Reported by user:** "also we need to remove adding tender without estimation [ this is a must to know that all is documented"

**Debug session:** @C:\Users\ester\ABcon\.planning\estimate-integration\phases\04-tender-integration\debug\prevent-standalone-tenders.md

## Available Resources

**From estimatesService:** `getEstimates(projectId: string, type?: 'planning' | 'execution'): Promise<Estimate[]>`

**Existing pattern:** Decision 010 - auto-create estimates on first access. If no estimates exist, prompt user to visit Financial tab first.
</context>

<tasks>

<task type="auto">
  <name>Add estimate selector to Add Tender modal with validation</name>
  <files>src/pages/Projects/tabs/TendersTab.tsx</files>
  <action>
Update Add Tender modal (lines 914-1028):

**1. Import estimatesService:**
Add to imports section (near top of file):
```typescript
import { getEstimates } from '../../../services/estimatesService';
```

**2. Add estimates state:**
Add near other state declarations (around line 30-50):
```typescript
const [estimates, setEstimates] = useState<Estimate[]>([]);
```

**3. Fetch estimates when component mounts:**
Add to useEffect that fetches initial data:
```typescript
const fetchedEstimates = await getEstimates(projectId);
setEstimates(fetchedEstimates);
```

**4. Add estimate_id to tenderForm state:**
Update tenderForm initial state (around line 60):
```typescript
estimate_id: '', // Add this field
```

**5. Add estimate dropdown to modal:**
Insert after the description textarea (after line 993, before milestone dropdown):
```typescript
<div>
  <label className="block text-sm font-bold mb-2">
    קישור להערכה <span className="text-red-500">*</span>
  </label>
  <select
    className="w-full h-10 px-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark text-sm focus:ring-1 focus:ring-primary focus:border-primary"
    value={tenderForm.estimate_id}
    onChange={(e) => setTenderForm({ ...tenderForm, estimate_id: e.target.value })}
  >
    <option value="">בחר הערכה</option>
    {estimates.map((est) => (
      <option key={est.id} value={est.id}>
        {est.estimate_type === 'planning' ? 'תכנון' : 'ביצוע'} - {est.name || 'ללא שם'} (₪{est.total_amount.toLocaleString('he-IL')})
      </option>
    ))}
  </select>
  {estimates.length === 0 && (
    <p className="text-xs text-amber-600 dark:text-amber-500 mt-1">
      לא נמצאו הערכות. צור הערכה תחילה בלשונית פיננסי.
    </p>
  )}
</div>
```

**6. Update submit button disabled condition:**
Change line 1018 from:
```typescript
disabled={!tenderForm.tender_name.trim() || !tenderForm.due_date}
```
To:
```typescript
disabled={!tenderForm.tender_name.trim() || !tenderForm.due_date || !tenderForm.estimate_id}
```

**7. Pass estimate_id to createTender:**
In handleAddTender function (around line 150-180), ensure estimate_id is included in the tender object passed to createTender (it should already be there from tenderForm).

**Why these specific changes:**
- Estimate selector is REQUIRED (red asterisk, validation)
- Shows estimate type (planning/execution), name, and total for clear selection
- Warning if no estimates exist (directs user to create one first)
- Validation at submit button (disabled if no estimate selected)
- Follows existing pattern of milestone dropdown (lines 995-1008)

**What NOT to change:**
- Do NOT modify the Export to Tender flow (PlanningEstimateSubTab/ExecutionEstimateSubTab) - that already works
- Do NOT change professional picker or other modals
- Do NOT modify tender card display logic
  </action>
  <verify>
```bash
# Verify import added
grep "import.*getEstimates.*estimatesService" src/pages/Projects/tabs/TendersTab.tsx

# Verify estimate dropdown exists
grep -A 10 "קישור להערכה" src/pages/Projects/tabs/TendersTab.tsx | grep "estimate_id"

# Verify validation includes estimate_id
grep "disabled=.*estimate_id" src/pages/Projects/tabs/TendersTab.tsx

# TypeScript compilation
npm run build
```
  </verify>
  <done>
- getEstimates imported from estimatesService
- estimates state declared and populated on mount
- estimate_id added to tenderForm
- Estimate dropdown added to modal with required indicator
- Submit button disabled if estimate_id empty
- Warning shown when no estimates exist
- TypeScript build succeeds
  </done>
</task>

<task type="auto">
  <name>Add service-layer validation requiring estimate_id</name>
  <files>src/services/tendersService.ts</files>
  <action>
Add validation at the start of createTender function (after line 94, before demo mode check):

```typescript
// Validate required estimate_id (all tenders must be linked to an estimate)
if (!tender.estimate_id) {
  throw new Error('Cannot create tender without estimate_id. All tenders must be linked to an estimate.');
}
```

**Why this specific change:**
- Defense-in-depth: UI validation can be bypassed, service validation cannot
- Clear error message for developers debugging
- Enforces business rule at data layer
- Placed before demo mode check so validation applies to both demo and real database

**What NOT to change:**
- Do NOT add this validation to updateTender (existing tenders might not have estimate_id)
- Do NOT validate bom_file_id (that's optional, added later in workflow)
- Do NOT modify transformTenderFromDB or other functions
  </action>
  <verify>
```bash
# Verify validation exists
grep -A 3 "if.*!tender.estimate_id" src/services/tendersService.ts

# Verify error message is clear
grep "Cannot create tender without estimate_id" src/services/tendersService.ts

# TypeScript compilation
npm run build
```
  </verify>
  <done>
- createTender validates estimate_id is present
- Throws clear error if missing
- Validation placed before demo mode check
- TypeScript build succeeds
- Service layer enforces business rule
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Updated Add Tender modal with required estimate dropdown and multi-layer validation. All new tenders must be linked to an estimate.
  </what-built>
  <how-to-verify>
**Test 1: Add Tender modal shows estimate selector**
1. Navigate to any project (e.g., "וילה פרטית - רמת אביב")
2. Go to Financial tab → Tenders sub-tab
3. Click "+ הוסף מכרז" button
4. Verify modal shows "קישור להערכה *" dropdown (red asterisk = required)
5. Verify dropdown lists available estimates with format: "תכנון/ביצוע - Name (₪Amount)"
6. Verify submit button is disabled until estimate selected

**Test 2: Cannot create tender without estimate**
1. Fill in all fields EXCEPT estimate dropdown (leave "בחר הערכה")
2. Try clicking "צור מכרז והוסף משתתפים" button
3. Verify button is disabled (grayed out)

**Test 3: Create tender with estimate succeeds**
1. Fill in all required fields INCLUDING estimate dropdown
2. Click "צור מכרז והוסף משתתפים"
3. Verify tender created successfully
4. Navigate to tender detail
5. Verify tender shows estimate link (should work now that estimate_id is saved)

**Test 4: Warning when no estimates exist**
1. Create a brand new project with no estimates
2. Go to Tenders sub-tab → click "+ הוסף מכרז"
3. Verify modal shows warning: "לא נמצאו הערכות. צור הערכה תחילה בלשונית פיננסי."
4. Verify estimate dropdown shows only "בחר הערכה" (no options)
5. Verify submit button disabled

**Test 5: Export to Tender still works (regression test)**
1. Go to Financial tab → Planning or Execution Estimate
2. Click "ייצא למכרז" button
3. Verify tender created and redirects to tender detail
4. Verify tender shows source estimate link
5. This should now work correctly (fixed in Plan 02)

**Expected results:**
- All new tenders require estimate selection
- Clear validation feedback (disabled button)
- Warning when no estimates available
- Export to Tender creates properly linked tenders
- No way to create standalone tenders through UI
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found (e.g., "Test 3 failed - no estimate link shown")
  </resume-signal>
</task>

</tasks>

<verification>
**Full integration test:**
1. Create estimate with items
2. Export to Tender → verify estimate_id populated
3. Try Add Tender without estimate → verify blocked
4. Add Tender with estimate → verify succeeds
5. Check database: all tenders have estimate_id NOT NULL
6. Select winner → verify budget creation accesses estimate data

**Business rule enforcement:**
- UI prevents submission without estimate (button disabled)
- Service throws error if estimate_id missing
- No way to create standalone tenders
- All documentation requirements met
</verification>

<success_criteria>
- Add Tender modal includes required estimate dropdown
- Form validation prevents submission without estimate
- Service-layer validation enforces estimate_id requirement
- Clear error messages and user guidance
- Export to Tender workflow unaffected
- All existing tenders continue to work (updateTender has no validation)
- User reported issue resolved: "we need to remove adding tender without estimation"
</success_criteria>

<output>
After completion, create `.planning/estimate-integration/phases/04-tender-integration/04-03-SUMMARY.md`
</output>
