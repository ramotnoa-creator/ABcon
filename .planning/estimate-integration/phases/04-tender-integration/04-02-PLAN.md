---
phase: 04-tender-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/services/tendersService.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Export to Tender button creates tender with estimate_id populated"
    - "Tender detail page shows source estimate link"
    - "Winner selection can access estimate data through tender.estimate_id"
  artifacts:
    - path: "src/services/tendersService.ts"
      provides: "createTender with estimate_id and bom_file_id persistence"
      contains: "estimate_id, bom_file_id"
  key_links:
    - from: "PlanningEstimateSubTab/ExecutionEstimateSubTab export handler"
      to: "tendersService.createTender"
      via: "estimate_id parameter"
      pattern: "estimate_id.*VALUES.*\\$17"
---

<objective>
Fix Export to Tender functionality - persist estimate_id and bom_file_id columns

**Purpose:** Resolve gap where Export to Tender creates tenders but estimate_id remains NULL because INSERT statement is missing these columns. Migration 002 added columns to schema, TypeScript types include them, but the INSERT was never updated.

**Output:** Export to Tender creates properly linked tenders that show source estimate and enable variance tracking.
</objective>

<execution_context>
@C:\Users\ester\ABcon\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ester\ABcon\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\ester\ABcon\.planning\STATE.md
@C:\Users\ester\ABcon\.planning\estimate-integration\ROADMAP.md
@C:\Users\ester\ABcon\.planning\estimate-integration\phases\04-tender-integration\04-01-SUMMARY.md

## Gap Details

**Root cause:** createTender INSERT statement (lines 108-132) missing estimate_id and bom_file_id columns. Handler passes estimate_id but service silently ignores it.

**Failed truth:** "Click Export to Tender button creates new tender with estimate data and redirects to tender page"

**Reported by user:** "in וילה פרטית - רמת אביב it dosent work"

**Debug session:** @C:\Users\ester\ABcon\.planning\estimate-integration\phases\04-tender-integration\debug\export-to-tender-villa-ramataviav.md
</context>

<tasks>

<task type="auto">
  <name>Add estimate_id and bom_file_id to createTender INSERT statement</name>
  <files>src/services/tendersService.ts</files>
  <action>
Update the createTender INSERT statement (lines 108-132):

**Current state:**
- Column list has 16 columns (project_id through management_remarks)
- VALUES has 16 placeholders ($1 through $16)
- Missing: estimate_id, bom_file_id

**Changes:**
1. Add `estimate_id, bom_file_id` to column list after line 112 (after management_remarks, before closing paren)
2. Update VALUES clause: change `$16)` to `$16, $17, $18)`
3. Add to values array after line 131:
   ```typescript
   tender.estimate_id || null,
   tender.bom_file_id || null,
   ```

**Why these specific changes:**
- estimate_id and bom_file_id are part of Tender type (from migration 002)
- Export handlers in PlanningEstimateSubTab/ExecutionEstimateSubTab already pass estimate_id
- These columns enable bidirectional estimate↔tender linking
- NULL is acceptable for standalone tenders (addressed in Plan 03)

**What NOT to change:**
- Do NOT modify demo mode logic (lines 95-104) - localStorage tenders already include all fields
- Do NOT add validation requiring estimate_id here - that's Plan 03's job
- Do NOT change other INSERT/UPDATE statements in the file
  </action>
  <verify>
```bash
# Verify column count matches placeholder count
grep -A 25 "INSERT INTO tenders" src/services/tendersService.ts | grep -E "(project_id|VALUES)" | wc -l

# Verify estimate_id and bom_file_id in column list
grep -A 5 "INSERT INTO tenders" src/services/tendersService.ts | grep "estimate_id, bom_file_id"

# Verify $17, $18 in VALUES
grep -A 15 "INSERT INTO tenders" src/services/tendersService.ts | grep '\$17, \$18'

# TypeScript compilation
npm run build
```
  </verify>
  <done>
- INSERT INTO tenders column list includes estimate_id and bom_file_id (18 columns total)
- VALUES clause has 18 placeholders ($1 through $18)
- Values array includes tender.estimate_id || null and tender.bom_file_id || null
- TypeScript build succeeds without errors
- Export to Tender functionality ready for E2E test (Plan 03 will add validation)
  </done>
</task>

</tasks>

<verification>
**Code verification:**
```bash
cd C:\Users\ester\ABcon
npm run build
```

**Manual test (after Plan 03 completes):**
1. Navigate to project "וילה פרטית - רמת אביב"
2. Go to Financial tab → Planning or Execution Estimate
3. Click "Export to Tender" button
4. Verify tender created (redirects to tender detail)
5. Check tender detail page shows source estimate link
6. Query database: `SELECT estimate_id FROM tenders WHERE tender_name = 'Test Export'` → should NOT be NULL
</verification>

<success_criteria>
- createTender INSERT includes estimate_id and bom_file_id columns
- Export to Tender creates tenders with populated estimate_id
- Bidirectional estimate↔tender linking works
- No TypeScript compilation errors
- No regression in existing tender creation flows
</success_criteria>

<output>
After completion, create `.planning/estimate-integration/phases/04-tender-integration/04-02-SUMMARY.md`
</output>
