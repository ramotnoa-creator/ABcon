---
phase: 05-budget-auto-update
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/pages/CostControl/tabs/BudgetTabContent.tsx
  - src/pages/Projects/tabs/subtabs/BudgetSubTab.tsx
  - src/components/Budget/VarianceCell.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Estimate column in budget tables"
    - "User sees Variance ₪ column in budget tables"
    - "User sees Variance % column in budget tables"
    - "Green color indicates savings (negative variance)"
    - "Red color indicates overrun (positive variance)"
    - "Gray color indicates no estimate linked"
    - "Filter 'Show items with variance only' works"
  artifacts:
    - path: "src/components/Budget/VarianceCell.tsx"
      provides: "Reusable variance display with color coding"
      exports: ["VarianceCell"]
    - path: "src/pages/CostControl/tabs/BudgetTabContent.tsx"
      provides: "Global budget with variance columns"
      contains: "Variance ₪"
    - path: "src/pages/Projects/tabs/subtabs/BudgetSubTab.tsx"
      provides: "Project budget with variance columns"
      contains: "Variance ₪"
  key_links:
    - from: "src/pages/CostControl/tabs/BudgetTabContent.tsx"
      to: "VarianceCell component"
      via: "table column rendering"
      pattern: "<VarianceCell.*varianceAmount"
    - from: "src/components/Budget/VarianceCell.tsx"
      to: "variance color logic"
      via: "useMemo hook"
      pattern: "useMemo.*getVarianceColor"
---

<objective>
Display variance data throughout the UI with consistent color coding and filtering.

Purpose: Make variance visible to users in all budget views. Enable quick identification of overruns (red) and savings (green).

Output: Budget tables show estimate and variance columns with color-coded indicators. Filter allows focusing on items with variance.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/estimate-integration/ROADMAP.md
@.planning/estimate-integration/phases/05-budget-auto-update/05-RESEARCH.md
@.planning/estimate-integration/phases/05-budget-auto-update/05-01-SUMMARY.md
@src/pages/CostControl/tabs/BudgetTabContent.tsx
@src/pages/Projects/tabs/subtabs/BudgetSubTab.tsx
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create VarianceCell component</name>
  <files>src/components/Budget/VarianceCell.tsx</files>
  <action>
Create reusable component for displaying variance with color coding.

**Component interface:**
```typescript
interface VarianceCellProps {
  estimateAmount?: number | null;
  budgetAmount: number;
  varianceAmount?: number | null;
  variancePercent?: number | null;
  showPercent?: boolean;
}
```

**Implementation requirements:**

1. **Color logic (using useMemo for performance):**
```typescript
const color = useMemo(() => {
  if (!estimateAmount || estimateAmount === 0) return 'gray';
  if ((varianceAmount || 0) < 0) return 'green'; // Saved money
  if ((varianceAmount || 0) > 0) return 'red'; // Over budget
  return 'gray'; // Exact match
}, [estimateAmount, varianceAmount]);
```

2. **Display logic:**
- If no estimate: Show dash (-) with gray color
- If showPercent: Show "±X.X%" with color
- If amount: Show "₪X,XXX" with color
- Use formatCurrency for numbers (already in codebase)

3. **Styling classes:**
```typescript
const colorClasses = {
  green: 'text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20',
  red: 'text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20',
  gray: 'text-gray-400 dark:text-gray-500',
};
```

4. **Accessibility:** Add aria-label describing variance direction

Follow pattern from RESEARCH.md "Pattern 3: Client-Side Variance Color Logic". Use useMemo not useEffect per React best practices.

**Why useMemo not useEffect:** Variance color is a pure calculation from props. Per React docs: "If you can calculate something during render, you don't need an Effect."
  </action>
  <verify>
```bash
npm run build
# Manual test: Render component with various props
# - estimateAmount: null → shows dash (-)
# - varianceAmount: -5000 → shows green
# - varianceAmount: 5000 → shows red
# - varianceAmount: 0 → shows gray
```
  </verify>
  <done>
- VarianceCell.tsx created and exported
- Component handles null/undefined estimates
- Color logic correct: green (savings), red (overrun), gray (no estimate)
- Uses useMemo for performance
- showPercent prop switches between ₪ and % display
- Dark mode support included
- TypeScript compilation succeeds
- Component is reusable (no tight coupling)
  </done>
</task>

<task type="auto">
  <name>Add variance columns to global Budget tab</name>
  <files>src/pages/CostControl/tabs/BudgetTabContent.tsx</files>
  <action>
Update global Cost Control Budget tab to display variance columns.

**Changes required:**

1. **Add columns to table header** (after Budget column, before Paid column):
```tsx
<th className="px-4 py-3 text-right">אומדן</th>
<th className="px-4 py-3 text-right">חריגה ₪</th>
<th className="px-4 py-3 text-right">חריגה %</th>
```

2. **Add cells in table body** (corresponding columns):
```tsx
{/* Estimate column */}
<td className="px-4 py-3 text-right">
  {item.estimate_amount ? (
    formatCurrency(item.estimate_amount)
  ) : (
    <span className="text-gray-400">-</span>
  )}
</td>

{/* Variance amount column */}
<td className="px-4 py-3 text-right">
  <VarianceCell
    estimateAmount={item.estimate_amount}
    budgetAmount={item.total_with_vat}
    varianceAmount={item.variance_amount}
  />
</td>

{/* Variance percent column */}
<td className="px-4 py-3 text-right">
  <VarianceCell
    estimateAmount={item.estimate_amount}
    budgetAmount={item.total_with_vat}
    variancePercent={item.variance_percent}
    showPercent
  />
</td>
```

3. **Add filter checkbox** (in existing filter bar):
```tsx
<label className="flex items-center gap-2">
  <input
    type="checkbox"
    checked={varianceOnlyFilter}
    onChange={(e) => setVarianceOnlyFilter(e.target.checked)}
    className="rounded border-gray-300"
  />
  <span className="text-sm">הצג רק פריטים עם חריגה</span>
</label>
```

4. **Add state:** `const [varianceOnlyFilter, setVarianceOnlyFilter] = useState(false);`

5. **Update filter logic** (in existing useMemo for filteredBudgetItems):
```typescript
if (varianceOnlyFilter) {
  filtered = filtered.filter((item) => item.estimate_amount && item.estimate_amount > 0);
}
```

6. **Import VarianceCell** at top of file

**DO NOT change existing functionality** - add columns, don't replace. Preserve existing filters, pagination, export button, row click handlers.

**Why filter on estimate_amount > 0:** Items with estimate_amount populated have variance tracking enabled. Items without estimates have NULL variance fields.
  </action>
  <verify>
```bash
npm run build
npm run dev
# Navigate to Cost Control → Budget tab
# Verify 3 new columns visible: אומדן, חריגה ₪, חריגה %
# Verify color coding: green for savings, red for overruns
# Check "הצג רק פריטים עם חריגה" filter
# Verify only items with estimates remain visible
# Uncheck filter → all items visible again
```
  </verify>
  <done>
- Three new columns added: Estimate, Variance ₪, Variance %
- VarianceCell component imported and used
- varianceOnlyFilter state added
- Filter checkbox renders in filter bar
- Filter logic works: shows only items with estimate_amount > 0
- Existing columns and functionality preserved
- Table remains responsive on mobile
- TypeScript compilation succeeds
- No console errors when viewing budget tab
  </done>
</task>

<task type="auto">
  <name>Add variance columns to project Budget sub-tab</name>
  <files>src/pages/Projects/tabs/subtabs/BudgetSubTab.tsx</files>
  <action>
Apply same variance column updates to project-level Budget sub-tab.

**Apply identical changes as Task 2:**
1. Add 3 columns: אומדן, חריגה ₪, חריגה %
2. Use VarianceCell component for variance display
3. Add "הצג רק פריטים עם חריגה" filter checkbox
4. Update filter logic to include varianceOnlyFilter
5. Import VarianceCell at top

**Additional consideration:** BudgetSubTab may have multiple view modes (tree, table, cashflow). Add variance columns to ALL applicable views where budget amounts are displayed.

**DO NOT modify:** Chapter structure, tree view hierarchy, existing calculations (paid_amount, balance), existing filters.

**Why project-level consistency:** Users expect same information in global and project views. Variance tracking must be consistent across navigation paths.
  </action>
  <verify>
```bash
npm run build
npm run dev
# Navigate to project detail → Financial tab → Budget sub-tab
# Verify 3 new columns in table view
# Verify color coding matches global tab
# Check filter works in project context
# Test tree view if applicable
# Verify responsive on mobile
```
  </verify>
  <done>
- Three new columns added to project Budget sub-tab
- VarianceCell component imported and used
- Filter checkbox renders and functions
- Variance visible in all view modes (table, tree, cashflow)
- Color coding consistent with global tab
- Existing budget functionality preserved
- TypeScript compilation succeeds
- No console errors in project budget view
  </done>
</task>

</tasks>

<verification>
**Visual verification checklist:**
1. Open Cost Control → Budget tab
   - [ ] See "אומדן" column header
   - [ ] See "חריגה ₪" column header
   - [ ] See "חריגה %"column header
   - [ ] Items with estimates show amounts, variance shows green/red
   - [ ] Items without estimates show dash (-) in all variance columns
   - [ ] Filter checkbox "הצג רק פריטים עם חריגה" visible
   - [ ] Checking filter hides items without estimates

2. Open project detail → Financial → Budget sub-tab
   - [ ] Same 3 columns visible
   - [ ] Same color coding
   - [ ] Same filter behavior

3. Color coding accuracy:
   - [ ] Variance < 0 (saved money) → green background/text
   - [ ] Variance > 0 (overrun) → red background/text
   - [ ] No estimate → gray text with dash (-)

4. Responsive design:
   - [ ] Columns visible on desktop (1920px)
   - [ ] Columns adapt on tablet (768px)
   - [ ] Scrollable table on mobile (375px)

**Data accuracy test:**
Create budget item with estimate_amount = 100000, total_with_vat = 95000
- [ ] Variance ₪ shows -5000 (green)
- [ ] Variance % shows -5.0% (green)

Create budget item with estimate_amount = 100000, total_with_vat = 105000
- [ ] Variance ₪ shows +5000 (red)
- [ ] Variance % shows +5.0% (red)
</verification>

<success_criteria>
- [ ] VarianceCell component created and exported
- [ ] Global Budget tab displays 3 new variance columns
- [ ] Project Budget sub-tab displays 3 new variance columns
- [ ] Color coding accurate: green (savings), red (overrun), gray (no estimate)
- [ ] Filter "Show items with variance only" works in both tabs
- [ ] Existing budget functionality preserved (no regressions)
- [ ] Responsive design maintained
- [ ] TypeScript compiles without errors
- [ ] No console errors in browser during usage
</success_criteria>

<output>
After completion, create `.planning/estimate-integration/phases/05-budget-auto-update/05-02-SUMMARY.md` documenting:
- VarianceCell component implementation
- UI changes in global and project budget tabs
- Filter functionality added
- Screenshots of variance display (if available)
- Color coding validation results
</output>
