---
phase: 05-budget-auto-update
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - package.json
  - src/pages/CostControl/tabs/BudgetTabContent.tsx
  - tests/budget-variance.spec.ts
autonomous: false

must_haves:
  truths:
    - "Excel export includes variance columns"
    - "Exported file has conditional formatting (color coding)"
    - "E2E tests cover winner → budget → variance flow"
    - "Tests verify color coding accuracy"
    - "Tests verify filter functionality"
  artifacts:
    - path: "package.json"
      provides: "ExcelJS dependency for styled exports"
      contains: "exceljs"
    - path: "src/pages/CostControl/tabs/BudgetTabContent.tsx"
      provides: "Enhanced export with conditional formatting"
      contains: "ExcelJS"
    - path: "tests/budget-variance.spec.ts"
      provides: "E2E test coverage for variance features"
      min_lines: 100
  key_links:
    - from: "src/pages/CostControl/tabs/BudgetTabContent.tsx"
      to: "ExcelJS workbook"
      via: "export handler"
      pattern: "new ExcelJS.Workbook"
    - from: "tests/budget-variance.spec.ts"
      to: "winner selection flow"
      via: "Playwright test"
      pattern: "test.*Winner selection.*variance"
---

<objective>
Complete Phase 5 with Excel export enhancement and comprehensive E2E testing.

Purpose: Enable users to export variance data with visual formatting. Ensure all variance features work correctly through automated tests.

Output: Excel files include variance columns with color coding. E2E tests validate entire workflow from winner selection to variance display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/estimate-integration/ROADMAP.md
@.planning/estimate-integration/phases/05-budget-auto-update/05-RESEARCH.md
@.planning/estimate-integration/phases/05-budget-auto-update/05-01-SUMMARY.md
@.planning/estimate-integration/phases/05-budget-auto-update/05-02-SUMMARY.md
@src/pages/CostControl/tabs/BudgetTabContent.tsx
@tests/tender-integration.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Install ExcelJS for styled exports</name>
  <files>package.json</files>
  <action>
Install ExcelJS library for Excel export with conditional formatting.

```bash
npm install exceljs
```

**Why ExcelJS over SheetJS:** The existing codebase uses SheetJS (xlsx) for basic exports, but SheetJS Community Edition doesn't support cell styling (background colors, font colors). ExcelJS is actively maintained (13k+ stars), supports conditional formatting, and doesn't require commercial license.

**Compatibility:** ExcelJS works alongside existing SheetJS. No need to remove xlsx dependency - BudgetTabContent can use ExcelJS for its enhanced export while other parts of app continue using SheetJS.

Per RESEARCH.md "Standard Stack" section, ExcelJS is the recommended solution for exports with styling.
  </action>
  <verify>
```bash
npm list exceljs
# Verify exceljs appears in package.json dependencies
grep -i exceljs package.json
npm run build
```
  </verify>
  <done>
- ExcelJS added to package.json dependencies
- npm install completed without errors
- TypeScript recognizes ExcelJS types
- No version conflicts with existing dependencies
- Build succeeds with new dependency
  </done>
</task>

<task type="auto">
  <name>Enhance Excel export with conditional formatting</name>
  <files>src/pages/CostControl/tabs/BudgetTabContent.tsx</files>
  <action>
Replace existing Excel export with ExcelJS version that includes variance columns and conditional formatting.

**Update handleExport function:**

1. **Import ExcelJS at top:**
```typescript
import * as ExcelJS from 'exceljs';
```

2. **Replace existing export logic** (around line 223-246):
```typescript
const handleExport = useCallback(async () => {
  const workbook = new ExcelJS.Workbook();
  const sheet = workbook.addWorksheet('תקציב');

  // RTL direction
  sheet.views = [{ rightToLeft: true }];

  // Define columns with headers
  sheet.columns = [
    { header: 'פרויקט', key: 'project', width: 20 },
    { header: 'קטגוריה', key: 'category', width: 15 },
    { header: 'פרק', key: 'chapter', width: 15 },
    { header: 'קוד', key: 'code', width: 10 },
    { header: 'תיאור', key: 'description', width: 30 },
    { header: 'אומדן', key: 'estimate', width: 15 },
    { header: 'תקציב', key: 'budget', width: 15 },
    { header: 'שולם', key: 'paid', width: 15 },
    { header: 'יתרה', key: 'balance', width: 15 },
    { header: 'חריגה ₪', key: 'variance_amount', width: 15 },
    { header: 'חריגה %', key: 'variance_percent', width: 12 },
    { header: 'סטטוס', key: 'status', width: 12 },
  ];

  // Add data rows
  filteredBudgetItems.forEach(item => {
    const hasEstimate = item.estimate_amount && item.estimate_amount > 0;

    sheet.addRow({
      project: item.project?.project_name || '',
      category: item.category?.name || '',
      chapter: item.chapter?.name || '',
      code: item.code || '',
      description: item.description,
      estimate: hasEstimate ? item.estimate_amount : '-',
      budget: item.total_with_vat,
      paid: item.paid_amount || 0,
      balance: item.total_with_vat - (item.paid_amount || 0),
      variance_amount: hasEstimate ? item.variance_amount : '-',
      variance_percent: hasEstimate ? `${item.variance_percent?.toFixed(1)}%` : '-',
      status: item.status,
    });
  });

  // Apply conditional formatting to variance columns (column 10 = variance_amount)
  sheet.getColumn(10).eachCell((cell, rowNumber) => {
    if (rowNumber === 1) return; // Skip header

    const item = filteredBudgetItems[rowNumber - 2];
    const hasEstimate = item.estimate_amount && item.estimate_amount > 0;

    if (!hasEstimate) {
      // Gray for no estimate
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFE5E7EB' } // gray-200
      };
      cell.font = { color: { argb: 'FF9CA3AF' } }; // gray-400
    } else if ((item.variance_amount || 0) < 0) {
      // Green for savings
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFD1FAE5' } // green-100
      };
      cell.font = { color: { argb: 'FF059669' }, bold: true }; // green-600
    } else if ((item.variance_amount || 0) > 0) {
      // Red for overrun
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFEE2E2' } // red-100
      };
      cell.font = { color: { argb: 'FFDC2626' }, bold: true }; // red-600
    }
  });

  // Apply same formatting to variance percent column (column 11)
  sheet.getColumn(11).eachCell((cell, rowNumber) => {
    if (rowNumber === 1) return;

    const item = filteredBudgetItems[rowNumber - 2];
    const hasEstimate = item.estimate_amount && item.estimate_amount > 0;

    if (!hasEstimate) {
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE5E7EB' } };
      cell.font = { color: { argb: 'FF9CA3AF' } };
    } else if ((item.variance_amount || 0) < 0) {
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD1FAE5' } };
      cell.font = { color: { argb: 'FF059669' }, bold: true };
    } else if ((item.variance_amount || 0) > 0) {
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
      cell.font = { color: { argb: 'FFDC2626' }, bold: true };
    }
  });

  // Style header row
  sheet.getRow(1).font = { bold: true };
  sheet.getRow(1).fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FFF3F4F6' } // gray-100
  };

  // Export file
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `budget-variance-${new Date().toISOString().split('T')[0]}.xlsx`;
  a.click();
  URL.revokeObjectURL(url);
}, [filteredBudgetItems]);
```

**Color scheme matches UI:** Green for savings, red for overruns, gray for no estimate. Uses Tailwind color values for consistency.

**Why async function:** ExcelJS writeBuffer() returns Promise. Make handleExport async and await the buffer generation.
  </action>
  <verify>
```bash
npm run build
npm run dev
# Navigate to Budget tab → click Export button
# Download Excel file
# Open in Excel/LibreOffice
# Verify:
# - 12 columns including variance columns
# - Green background/text for negative variance
# - Red background/text for positive variance
# - Gray for items without estimates
# - RTL text direction
# - Data matches UI
```
  </verify>
  <done>
- ExcelJS imported in BudgetTabContent.tsx
- handleExport function replaced with ExcelJS implementation
- Excel file includes all columns (estimate, variance ₪, variance %)
- Conditional formatting applied: green (savings), red (overrun), gray (no estimate)
- RTL direction set for Hebrew text
- File downloads successfully
- TypeScript compilation succeeds
- No console errors during export
  </done>
</task>

<task type="auto">
  <name>Create E2E tests for variance workflow</name>
  <files>tests/budget-variance.spec.ts</files>
  <action>
Create comprehensive Playwright E2E test suite for budget variance features.

**Test file structure:**
```typescript
import { test, expect } from '@playwright/test';

test.describe('Budget Variance - End to End', () => {

  test('Winner selection creates budget with variance calculation', async ({ page }) => {
    // 1. Navigate to project
    // 2. Create planning estimate with item (₪150,000)
    // 3. Export to tender
    // 4. Add participant
    // 5. Enter participant quote (₪145,000)
    // 6. Select winner → confirm modal
    // 7. Navigate to Budget tab
    // 8. Verify budget item exists with:
    //    - Estimate: ₪150,000
    //    - Budget: ₪145,000
    //    - Variance ₪: -₪5,000 (green)
    //    - Variance %: -3.3% (green)
  });

  test('Budget tab displays variance columns correctly', async ({ page }) => {
    // 1. Navigate to Cost Control → Budget tab
    // 2. Verify column headers exist: "אומדן", "חריגה ₪", "חריגה %"
    // 3. Verify items with estimates show values
    // 4. Verify items without estimates show dash (-)
    // 5. Verify color coding:
    //    - Find item with negative variance → check green class
    //    - Find item with positive variance → check red class
  });

  test('Variance filter works correctly', async ({ page }) => {
    // 1. Navigate to Budget tab
    // 2. Count total items displayed
    // 3. Check "הצג רק פריטים עם חריגה" filter
    // 4. Count filtered items (should be less)
    // 5. Verify all visible items have estimate_amount
    // 6. Uncheck filter
    // 7. Verify item count returns to original
  });

  test('Project budget sub-tab shows variance', async ({ page }) => {
    // 1. Navigate to project detail → Financial tab → Budget sub-tab
    // 2. Verify same columns as global tab
    // 3. Verify same color coding
    // 4. Verify filter works
  });

  test('Excel export includes variance with formatting', async ({ page }) => {
    // 1. Navigate to Budget tab
    // 2. Click Export button
    // 3. Wait for download
    // 4. Verify file exists
    // 5. Parse Excel file (using exceljs in test)
    // 6. Verify headers include variance columns
    // 7. Verify data row count matches UI
    // 8. Verify cell styles applied (check fill.fgColor for green/red)
  });

  test('Variance recalculates when estimate changes', async ({ page }) => {
    // 1. Create estimate with item
    // 2. Export to tender → select winner → budget created
    // 3. Note original variance
    // 4. Edit estimate item amount
    // 5. Navigate back to budget
    // 6. Verify variance updated to reflect new estimate
    // 7. Verify color changes if crossed zero threshold
  });

  test('Color coding accuracy', async ({ page }) => {
    // Create test scenarios:
    // - Budget < Estimate (savings) → verify green
    // - Budget > Estimate (overrun) → verify red
    // - Budget = Estimate (exact) → verify gray
    // - No estimate → verify gray dash
  });
});
```

**Test data strategy:** Create fresh test estimates/tenders in each test for isolation. Use unique project names or cleanup after tests.

**Assertions to include:**
- Element visibility (`expect(element).toBeVisible()`)
- Text content (`expect(element).toHaveText('...')`)
- CSS classes for colors (`expect(element).toHaveClass(/green|red|gray/)`)
- Count assertions for filter tests
- File existence for export tests

Follow pattern from existing `tests/tender-integration.spec.ts` for page navigation and element selectors.
  </action>
  <verify>
```bash
npm run test
# All tests should pass
# Coverage should include:
# - Winner → budget creation
# - Variance display in both tabs
# - Filter functionality
# - Color coding
# - Excel export
```
  </verify>
  <done>
- Test file budget-variance.spec.ts created
- 6-7 test cases covering all variance features
- Tests use Playwright best practices (page object pattern if applicable)
- All tests pass on first run
- Tests are deterministic (no flaky failures)
- Test coverage includes happy path and edge cases
- Console shows no errors during test execution
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete budget variance system: database triggers, auto-creation, UI display, Excel export, E2E tests.

All automated tasks completed:
- Database triggers for auto-variance calculation
- Winner selection creates budget items with estimate linking
- Variance displayed in global and project budget tabs with color coding
- Filter to show only items with variance
- Excel export with conditional formatting (green/red/gray cells)
- E2E test suite validates entire workflow
  </what-built>

  <how-to-verify>
**Manual Verification Steps:**

1. **Test Winner → Budget → Variance Flow:**
   - Open browser to dev server (npm run dev)
   - Navigate to a project → Financial tab → Planning Estimate sub-tab
   - Create new estimate item: "Test Flooring", quantity: 100, unit price: 1500, total: ₪150,000
   - Click "Export to Tender"
   - In Tenders sub-tab, find new tender
   - Add participant (select any professional)
   - Enter participant quote: ₪145,000
   - Click "Select Winner" → Confirm in modal
   - Navigate to Budget sub-tab
   - **Verify:** Budget item exists with:
     - Description: Matches tender name
     - Estimate: ₪150,000
     - Budget: ₪145,000
     - Variance ₪: -₪5,000 with GREEN background
     - Variance %: -3.3% with GREEN background

2. **Test Global Budget Tab:**
   - Navigate to Cost Control → Budget tab
   - **Verify:** Columns visible: אומדן, חריגה ₪, חריגה %
   - **Verify:** Items with estimates show values with color coding
   - **Verify:** Items without estimates show dash (-)
   - Check "הצג רק פריטים עם חריגה" filter
   - **Verify:** Only items with estimates remain visible
   - Uncheck filter
   - **Verify:** All items return

3. **Test Excel Export:**
   - In Budget tab, click Export button
   - Open downloaded Excel file
   - **Verify:** File has columns: Project, Category, Chapter, Code, Description, Estimate, Budget, Paid, Balance, Variance ₪, Variance %, Status
   - **Verify:** Variance cells have colored backgrounds:
     - Green background for negative variance (savings)
     - Red background for positive variance (overruns)
     - Gray background for no estimate
   - **Verify:** Numbers match UI

4. **Test Variance Recalculation:**
   - Edit estimate item amount (change from ₪150,000 to ₪160,000)
   - Navigate back to Budget tab
   - **Verify:** Variance automatically updated (should now show +₪15,000 RED for overrun if budget is ₪145,000)

5. **Test Color Coding Edge Cases:**
   - Create scenario where Budget = Estimate (variance = 0)
   - **Verify:** Shows ₪0 with gray color (not green or red)
   - Create scenario with large overrun (e.g., budget ₪200k, estimate ₪100k)
   - **Verify:** Shows +₪100,000 with RED, +100.0% RED

6. **Run E2E Tests:**
   ```bash
   npm run test
   ```
   - **Verify:** All tests in budget-variance.spec.ts pass
   - **Verify:** No flaky test failures (run twice to confirm)

**Expected Results:**
- All manual tests above show correct behavior
- Color coding is accurate and consistent
- Excel export preserves formatting
- E2E tests pass (100% pass rate)
- No console errors in browser during any test
- No TypeScript compilation errors

**Report Issues:**
If any verification step fails, describe:
- Which step failed
- Expected behavior
- Actual behavior
- Screenshots if visual issue
- Console errors if applicable
  </how-to-verify>

  <resume-signal>
Type "approved" if all verification steps pass and system works correctly.
Type "issues" followed by description if problems found.
  </resume-signal>
</task>

</tasks>

<verification>
**Automated verification (before checkpoint):**
```bash
# Build succeeds
npm run build

# E2E tests pass
npm run test -- tests/budget-variance.spec.ts

# No TypeScript errors
npx tsc --noEmit
```

**Manual verification (during checkpoint):**
- Complete workflow: Estimate → Tender → Winner → Budget with variance
- Variance display in both global and project tabs
- Color coding accuracy (green/red/gray)
- Filter functionality
- Excel export with conditional formatting
- Database triggers fire automatically
- Performance acceptable (no lag with variance calculations)

**Success criteria for checkpoint approval:**
- All 6 manual verification steps pass
- E2E tests pass (100%)
- Excel export opens correctly with formatting
- Variance calculations accurate (±0.01 tolerance)
- Color coding matches specification
- No console errors during usage
</verification>

<success_criteria>
- [ ] ExcelJS installed and integrated
- [ ] Excel export includes variance columns with conditional formatting
- [ ] Export file uses correct color scheme (green/red/gray)
- [ ] E2E test file created with 6+ test cases
- [ ] All E2E tests pass without flaky failures
- [ ] Tests cover: winner flow, display, filter, export, recalculation
- [ ] Manual verification checkpoint completed and approved
- [ ] TypeScript compiles without errors
- [ ] No regressions in existing functionality
</success_criteria>

<output>
After completion and checkpoint approval, create `.planning/estimate-integration/phases/05-budget-auto-update/05-03-SUMMARY.md` documenting:
- ExcelJS integration for styled exports
- Excel export implementation with conditional formatting
- E2E test coverage and results
- Manual verification results
- Screenshots of Excel export (if available)
- Any issues found and resolved during verification
- Phase 5 completion confirmation
</output>
