---
phase: 05-budget-auto-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/006-add-budget-variance-triggers.sql
  - src/components/Tenders/WinnerSelectionModal.tsx
  - src/services/budgetItemsService.ts
autonomous: true

must_haves:
  truths:
    - "Winner selection automatically creates budget item"
    - "Budget item links to tender and estimate item"
    - "Variance fields populate automatically on budget creation"
    - "Variance recalculates when estimate amounts change"
  artifacts:
    - path: "migrations/006-add-budget-variance-triggers.sql"
      provides: "Database triggers for auto-variance calculation"
      contains: "CREATE TRIGGER budget_variance_trigger"
    - path: "src/components/Tenders/WinnerSelectionModal.tsx"
      provides: "Winner confirmation creates budget item"
      min_lines: 200
    - path: "src/services/budgetItemsService.ts"
      provides: "Budget creation with estimate linking"
      exports: ["createBudgetItem", "updateBudgetItem"]
  key_links:
    - from: "src/components/Tenders/WinnerSelectionModal.tsx"
      to: "createBudgetItem"
      via: "confirmation handler"
      pattern: "createBudgetItem.*tender_id.*estimate_item_id"
    - from: "migrations/006-add-budget-variance-triggers.sql"
      to: "budget_items table"
      via: "BEFORE INSERT OR UPDATE trigger"
      pattern: "CREATE TRIGGER.*budget_items"
---

<objective>
Implement automated budget creation from winner selection with database-level variance calculation triggers.

Purpose: Close the loop between tender winner selection and budget tracking. Ensure variance calculations are consistent and automatic at the database level.

Output: Winner selection creates budget items with automatic variance calculation via PostgreSQL triggers. Estimates and budgets stay synchronized.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/estimate-integration/ROADMAP.md
@.planning/estimate-integration/phases/05-budget-auto-update/05-RESEARCH.md
@src/services/varianceService.ts
@src/services/budgetItemsService.ts
@src/services/tenderParticipantsService.ts
@src/components/Tenders/WinnerSelectionModal.tsx
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create database migration with variance triggers</name>
  <files>migrations/006-add-budget-variance-triggers.sql</files>
  <action>
Create migration file that adds PostgreSQL triggers for automatic variance calculation on budget_items table.

**Trigger 1: Auto-calculate variance on INSERT/UPDATE**
- BEFORE INSERT OR UPDATE trigger on budget_items
- Calculates variance_amount = NEW.total_with_vat - estimate_total
- Calculates variance_percent = (variance_amount / estimate_total) * 100
- Fetches estimate amount from estimate_items via estimate_item_id FK
- Handles NULL estimate_item_id (sets variance fields to NULL)
- Handles zero division (estimate_total = 0)

**Trigger 2: Recalculate budget variances when estimate changes**
- AFTER UPDATE trigger on estimate_items (when total_with_vat changes)
- Updates all linked budget_items variance fields
- Uses UPDATE statement with calculation in SET clause
- Only fires when OLD.total_with_vat IS DISTINCT FROM NEW.total_with_vat

Follow pattern from RESEARCH.md Pattern 1 and Pattern 2. Use DECIMAL(15,2) for monetary values. Use PL/pgSQL language.

**Why database triggers not application-level:** Guarantees consistency across all code paths, eliminates race conditions, ensures variance accuracy regardless of how budget items are created/updated (UI, scripts, imports).
  </action>
  <verify>
Run migration and test trigger behavior:
```bash
npm run migrate
# Test INSERT with estimate link
psql -c "INSERT INTO budget_items (estimate_item_id, total_with_vat, ...) VALUES (...); SELECT variance_amount, variance_percent FROM budget_items WHERE id = ...;"
# Test UPDATE estimate_items
psql -c "UPDATE estimate_items SET total_with_vat = ... WHERE id = ...; SELECT variance_amount FROM budget_items WHERE estimate_item_id = ...;"
```
Verify variance fields populate automatically without application code.
  </verify>
  <done>
- Migration file exists and is idempotent
- budget_variance_trigger fires BEFORE INSERT OR UPDATE on budget_items
- estimate_update_recalc_trigger fires AFTER UPDATE on estimate_items
- Variance calculations match formula: budget - estimate
- Handles NULL estimate_item_id gracefully
- npm run migrate succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Implement budget auto-creation in winner selection</name>
  <files>src/components/Tenders/WinnerSelectionModal.tsx</files>
  <action>
Update WinnerSelectionModal to automatically create budget item when winner is confirmed.

**Modify handleConfirm handler:**

1. Import budgetItemsService at top: `import { createBudgetItem } from '../../../services/budgetItemsService';`

2. After setting winner in tender_participants, create budget item:
```typescript
// Get estimate items if tender has estimate link
let estimateItemId: string | undefined;
if (tender.estimate_id) {
  const estimateItems = await getEstimateItems(tender.estimate_id);
  // Link to first item (MVP - future: match by description or allow selection)
  estimateItemId = estimateItems[0]?.id;
}

// Determine chapter for budget item (use utility or default)
const chapterId = tender.chapter_id || DEFAULT_CHAPTER_ID;

// Create budget item (trigger will auto-calculate variance)
const budgetItem = await createBudgetItem({
  project_id: tender.project_id,
  chapter_id: chapterId,
  description: tender.tender_name,
  total_price: contractAmount / 1.17, // Reverse calculate from total_with_vat
  vat_rate: 0.17,
  vat_amount: contractAmount * (0.17 / 1.17),
  total_with_vat: contractAmount,
  status: 'contracted',
  supplier_id: winnerParticipant.professional_id,
  tender_id: tender.id,
  estimate_item_id: estimateItemId,
  source_estimate_id: tender.estimate_id,
  paid_amount: 0,
  order: await getNextBudgetItemOrder(tender.project_id, chapterId)
});
```

3. Show success toast: "Budget item created successfully"

4. Handle errors gracefully with toast notification

**DO NOT manually calculate variance** - database trigger handles it. Just pass estimate_item_id.

**Why first estimate item:** For MVP, tenders typically represent single-item estimates. Phase 6 can add item matching logic if needed.
  </action>
  <verify>
```bash
npm run build
npm run dev
# Manual test: Create estimate → Export to tender → Add participant → Select winner
# Verify budget item created in database with variance fields populated
# Check: estimate_item_id, variance_amount, variance_percent are not NULL
```
  </verify>
  <done>
- Winner confirmation handler calls createBudgetItem
- Budget item links to tender via tender_id
- Budget item links to estimate item via estimate_item_id
- Budget item links to source estimate via source_estimate_id
- Success/error toasts display appropriately
- Database trigger populates variance fields automatically
- TypeScript compilation succeeds
- No console errors during winner selection flow
  </done>
</task>

<task type="auto">
  <name>Add variance helper utility function</name>
  <files>src/services/budgetItemsService.ts</files>
  <action>
Add helper function for getting next budget item order (needed by WinnerSelectionModal).

**Add export to budgetItemsService.ts:**
```typescript
/**
 * Get next order number for budget item in chapter
 */
export async function getNextBudgetItemOrder(
  projectId: string,
  chapterId: string
): Promise<number> {
  if (isDemoMode) {
    return getNextBudgetItemOrderLocal(projectId, chapterId);
  }

  try {
    const result = await executeQuerySingle<{ max_order: number }>(
      `SELECT COALESCE(MAX("order"), 0) as max_order
       FROM budget_items
       WHERE project_id = $1 AND chapter_id = $2`,
      [projectId, chapterId]
    );

    return (result?.max_order || 0) + 1;
  } catch (error: unknown) {
    console.error('Error getting next budget item order:', error);
    return getNextBudgetItemOrderLocal(projectId, chapterId);
  }
}
```

Function already exists in codebase (imported from budgetItemsStorage), but may not be exported. Verify export exists, add if missing.

**Why needed:** Winner selection needs to create budget item with proper ordering within chapter.
  </action>
  <verify>
```bash
npm run build
# Verify export in budgetItemsService.ts
grep "export.*getNextBudgetItemOrder" src/services/budgetItemsService.ts
```
  </verify>
  <done>
- getNextBudgetItemOrder function exported from budgetItemsService.ts
- Function handles demo mode fallback
- Returns correct next order number (max + 1)
- TypeScript compilation succeeds
- No import errors in WinnerSelectionModal
  </done>
</task>

</tasks>

<verification>
**End-to-end workflow test:**
1. Create planning estimate with item (e.g., ₪150,000)
2. Export estimate to tender
3. Add participant to tender
4. Enter participant quote amount (e.g., ₪145,000)
5. Click "Select Winner" → confirm modal
6. Verify budget item created in database:
   - tender_id matches tender
   - estimate_item_id matches estimate item
   - variance_amount = -5000 (saved money)
   - variance_percent = -3.33
7. Update estimate item amount in database
8. Verify budget item variance recalculates automatically

**Database trigger validation:**
```sql
-- Test trigger fires
INSERT INTO budget_items (project_id, chapter_id, description, total_with_vat, estimate_item_id, ...)
VALUES (...);
SELECT estimate_amount, variance_amount, variance_percent FROM budget_items WHERE id = ...;

-- Test estimate update propagates
UPDATE estimate_items SET total_with_vat = 160000 WHERE id = ...;
SELECT variance_amount FROM budget_items WHERE estimate_item_id = ...;
```

**Success criteria:**
- All triggers create successfully
- Variance calculations are automatic and accurate
- Winner selection completes in < 3 seconds
- No manual variance updates needed
- Database maintains consistency
</verification>

<success_criteria>
- [ ] Migration 006 runs successfully without errors
- [ ] Database triggers exist: budget_variance_trigger, estimate_update_recalc_trigger
- [ ] Winner selection creates budget item with all linkages
- [ ] Variance fields (estimate_amount, variance_amount, variance_percent) populate automatically
- [ ] Variance formula correct: budget - estimate (positive = overrun, negative = savings)
- [ ] Estimate changes trigger budget variance recalculation
- [ ] TypeScript compiles without errors
- [ ] Manual E2E test passes: estimate → tender → winner → budget with variance
</success_criteria>

<output>
After completion, create `.planning/estimate-integration/phases/05-budget-auto-update/05-01-SUMMARY.md` documenting:
- Database triggers created and tested
- Budget auto-creation flow implemented
- Variance calculation automated
- Integration test results
- Files modified and decisions made
</output>
