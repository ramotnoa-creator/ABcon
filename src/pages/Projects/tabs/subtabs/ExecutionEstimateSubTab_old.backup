import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useToast } from '../../../../contexts/ToastContext';
import {
  getEstimates,
  createEstimate,
  updateEstimate,
  exportEstimateToTender,
  markEstimateAsModified
} from '../../../../services/estimatesService';
import { getEstimateItems, deleteEstimateItem } from '../../../../services/estimateItemsService';
import { getTenderById, updateTenderFromEstimate } from '../../../../services/tendersService';
import AddEstimateItemForm from '../../../../components/Estimates/AddEstimateItemForm';
import EstimateItemsTable from '../../../../components/Estimates/EstimateItemsTable';
import EstimateSummaryCard from '../../../../components/Estimates/EstimateSummaryCard';
import LinkedTenderCard from '../../../../components/Estimates/LinkedTenderCard';
import type { Estimate, EstimateItem, Tender } from '../../../../types';

interface ExecutionEstimateSubTabProps {
  projectId: string;
  projectName: string;
}

export default function ExecutionEstimateSubTab({ projectId, projectName }: ExecutionEstimateSubTabProps) {
  const navigate = useNavigate();
  const { showToast } = useToast();
  const [estimate, setEstimate] = useState<Estimate | null>(null);
  const [items, setItems] = useState<EstimateItem[]>([]);
  const [linkedTender, setLinkedTender] = useState<Tender | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingItem, setEditingItem] = useState<EstimateItem | null>(null);
  const [isExporting, setIsExporting] = useState(false);

  // Load or create execution estimate
  useEffect(() => {
    const loadEstimate = async () => {
      try {
        setIsLoading(true);
        const estimates = await getEstimates(projectId, 'execution');

        let executionEstimate: Estimate;
        if (estimates.length === 0) {
          // Auto-create execution estimate if none exists
          executionEstimate = await createEstimate({
            project_id: projectId,
            estimate_type: 'execution',
            name: `${projectName} - ××•××“×Ÿ ×‘×™×¦×•×¢`,
            total_amount: 0,
            status: 'active',
          });
          showToast('××•××“×Ÿ ×‘×™×¦×•×¢ × ×•×¦×¨ ×‘×”×¦×œ×—×”', 'success');
        } else {
          executionEstimate = estimates[0];
        }

        setEstimate(executionEstimate);

        // Load items
        const estimateItems = await getEstimateItems(executionEstimate.id);
        setItems(estimateItems);

        // Load linked tender if exists
        if (executionEstimate.tender_id) {
          const tender = await getTenderById(executionEstimate.tender_id);
          setLinkedTender(tender);
        }
      } catch (error) {
        console.error('Error loading execution estimate:', error);
        showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ××•××“×Ÿ ×‘×™×¦×•×¢', 'error');
      } finally {
        setIsLoading(false);
      }
    };

    loadEstimate();
  }, [projectId, projectName, showToast]);

  const handleItemAdded = async (newItem: EstimateItem) => {
    setItems((prev) => [...prev, newItem]);
    setShowAddForm(false);
    showToast('×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');

    // Mark estimate as modified if it has a linked tender
    if (estimate?.tender_id) {
      try {
        await markEstimateAsModified(estimate.id);
        // Reload tender to show outdated flag
        const tender = await getTenderById(estimate.tender_id);
        setLinkedTender(tender);
      } catch (error) {
        console.error('Error marking estimate as modified:', error);
      }
    }
  };

  const handleItemUpdated = async (updatedItem: EstimateItem) => {
    setItems((prev) => prev.map((item) => (item.id === updatedItem.id ? updatedItem : item)));
    setEditingItem(null);
    showToast('×¤×¨×™×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');

    // Mark estimate as modified if it has a linked tender
    if (estimate?.tender_id) {
      try {
        await markEstimateAsModified(estimate.id);
        // Reload tender to show outdated flag
        const tender = await getTenderById(estimate.tender_id);
        setLinkedTender(tender);
      } catch (error) {
        console.error('Error marking estimate as modified:', error);
      }
    }
  };

  const handleDeleteItem = async (itemId: string) => {
    if (!window.confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) {
      return;
    }

    try {
      await deleteEstimateItem(itemId);
      setItems((prev) => prev.filter((item) => item.id !== itemId));
      showToast('×¤×¨×™×˜ × ××—×§ ×‘×”×¦×œ×—×”', 'success');

      // Mark estimate as modified if it has a linked tender
      if (estimate?.tender_id) {
        try {
          await markEstimateAsModified(estimate.id);
          // Reload tender to show outdated flag
          const tender = await getTenderById(estimate.tender_id);
          setLinkedTender(tender);
        } catch (error) {
          console.error('Error marking estimate as modified:', error);
        }
      }
    } catch (error) {
      console.error('Error deleting item:', error);
      showToast('×©×’×™××” ×‘××—×™×§×ª ×¤×¨×™×˜', 'error');
    }
  };

  const handleExportToTender = async () => {
    if (!estimate) return;

    // Check if already exported (1:1 enforcement)
    if (estimate.tender_id) {
      if (window.confirm('××•××“×Ÿ ×–×” ×›×‘×¨ ×™×•×¦× ×œ××›×¨×–. ×”×× ×‘×¨×¦×•× ×š ×œ×¦×¤×•×ª ×‘××›×¨×– ×”×§×™×™×?')) {
        navigate(`/projects/${projectId}?tab=tenders`);
      }
      return;
    }

    // Check if locked
    if (estimate.status === 'locked') {
      showToast('×œ× × ×™×ª×Ÿ ×œ×™×™×¦× ××•××“×Ÿ × ×¢×•×œ ×œ××›×¨×–', 'error');
      return;
    }

    try {
      setIsExporting(true);

      // Use the enhanced export function
      const newTenderId = await exportEstimateToTender(estimate.id, {
        project_id: projectId,
        tender_name: `${estimate.name} - ××›×¨×–`,
        description: estimate.description,
        status: 'Draft',
        publish_date: new Date().toISOString(),
        candidate_professional_ids: [],
        tender_type: 'contractor',
      });

      // Update local state
      const updatedEstimate = {
        ...estimate,
        status: 'exported_to_tender' as const,
        tender_id: newTenderId,
        exported_at: new Date().toISOString(),
      };
      setEstimate(updatedEstimate);

      // Load the newly created tender
      const newTender = await getTenderById(newTenderId);
      setLinkedTender(newTender);

      showToast('××›×¨×– × ×•×¦×¨ ×××•××“×Ÿ ×‘×”×¦×œ×—×”', 'success');

      // Auto-navigate to tender detail page
      navigate(`/projects/${projectId}?tab=tenders`);
    } catch (error: any) {
      console.error('Error exporting to tender:', error);
      showToast(error.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ××›×¨×–', 'error');
    } finally {
      setIsExporting(false);
    }
  };

  const handleUpdateTenderFromEstimate = async () => {
    if (!estimate?.tender_id || !linkedTender) return;

    try {
      const { oldBudget, newBudget } = await updateTenderFromEstimate(
        estimate.tender_id,
        estimate.id
      );

      // Reload tender
      const updatedTender = await getTenderById(estimate.tender_id);
      setLinkedTender(updatedTender);

      showToast(
        `××›×¨×– ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” (×ª×§×¦×™×‘: ${oldBudget.toLocaleString()} â† ${newBudget.toLocaleString()})`,
        'success'
      );
    } catch (error: any) {
      console.error('Error updating tender from estimate:', error);
      showToast(error.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××›×¨×–', 'error');
    }
  };

  const handleExportToExcel = () => {
    showToast('×™×™×¦×•× ×œ××§×¡×œ - ×‘×¤×™×ª×•×—', 'info');
  };

  if (isLoading || !estimate) {
    return (
      <div className="flex items-center gap-3 text-text-secondary-light dark:text-text-secondary-dark">
        <div className="size-5 border-2 border-current border-t-transparent rounded-full animate-spin" />
        <p>×˜×•×¢×Ÿ ××•××“×Ÿ...</p>
      </div>
    );
  }

  const isLocked = estimate.status === 'locked';
  const hasExported = !!estimate.tender_id;

  return (
    <div className="execution-estimate-subtab">
      {/* Lock Warning Banner */}
      {isLocked && (
        <div className="bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl p-4 mb-6">
          <div className="flex items-start gap-3">
            <span className="material-symbols-outlined text-red-600 dark:text-red-400 text-[24px]">
              lock
            </span>
            <div>
              <div className="text-sm font-bold text-red-800 dark:text-red-200 mb-1">
                ğŸ”’ ××•××“×Ÿ ×–×” × ×¢×•×œ
              </div>
              <div className="text-xs text-red-700 dark:text-red-300">
                ×–×•×›×” × ×‘×—×¨ ×‘××›×¨×–. ×¢×¨×™×›×ª ×”××•××“×Ÿ ×—×¡×•××”. ×¤× ×” ×œ×× ×”×œ ×œ×¤×ª×™×—×ª × ×¢×™×œ×” ×‘××§×¨×” ×”×¦×•×¨×š.
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Export Warning Banner - when already exported */}
      {hasExported && !isLocked && (
        <div className="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-6">
          <div className="flex items-start gap-3">
            <span className="material-symbols-outlined text-blue-600 dark:text-blue-400 text-[24px]">
              info
            </span>
            <div>
              <div className="text-sm font-bold text-blue-800 dark:text-blue-200 mb-1">
                ××•××“×Ÿ ×–×” ×™×•×¦× ×œ××›×¨×–
              </div>
              <div className="text-xs text-blue-700 dark:text-blue-300">
                ×©×™× ×•×™×™× ×‘××•××“×Ÿ ×œ× ×™×¢×•×“×›× ×• ××•×˜×•××˜×™×ª ×‘××›×¨×–. ×”×©×ª××© ×‘×›×¤×ª×•×¨ "×¢×“×›×•×Ÿ ××›×¨×–" ×œ×”×¢×‘×¨×ª ×©×™× ×•×™×™×.
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Linked Tender Card */}
      {linkedTender && (
        <LinkedTenderCard
          estimateId={estimate.id}
          projectId={projectId}
          tender={linkedTender}
          onUpdateTender={handleUpdateTenderFromEstimate}
        />
      )}

      {/* Summary Cards */}
      <EstimateSummaryCard estimate={estimate} items={items} />

      {/* Export to Tender Button (Page-level, prominent) */}
      {!hasExported && !isLocked && (
        <div className="mb-6">
          <button
            onClick={handleExportToTender}
            disabled={isExporting}
            className="flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-bold text-lg w-full md:w-auto justify-center"
          >
            {isExporting ? (
              <>
                <div className="size-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                ×™×•×¦× ×œ××›×¨×–...
              </>
            ) : (
              <>
                <span className="material-symbols-outlined text-[24px]">gavel</span>
                ×™×™×¦×•× ×œ××›×¨×–
              </>
            )}
          </button>
        </div>
      )}

      {/* Action Buttons */}
      <div className="flex gap-3 mb-6">
        <button
          onClick={() => setShowAddForm(true)}
          disabled={isLocked}
          className="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover active:bg-primary/80 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none transition-colors font-semibold"
        >
          <span className="material-symbols-outlined text-[20px]">add</span>
          ×”×•×¡×£ ×¤×¨×™×˜
        </button>
        <button
          onClick={handleExportToExcel}
          className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors font-semibold"
        >
          <span className="material-symbols-outlined text-[20px]">download</span>
          ×™×™×¦×•× ×œ××§×¡×œ
        </button>
      </div>

      {/* Items Table */}
      <EstimateItemsTable
        items={items}
        onEdit={isLocked ? undefined : setEditingItem}
        onDelete={isLocked ? undefined : handleDeleteItem}
      />

      {/* Add/Edit Form Modal */}
      {(showAddForm || editingItem) && (
        <AddEstimateItemForm
          estimateId={estimate.id}
          item={editingItem}
          onSave={editingItem ? handleItemUpdated : handleItemAdded}
          onCancel={() => {
            setShowAddForm(false);
            setEditingItem(null);
          }}
        />
      )}
    </div>
  );
}
